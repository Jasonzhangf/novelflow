## Flowgram ECS 架构下的变量生命周期：从声明到消费

在 Flowgram 的 ECS（Entity-Component-System）架构下，变量的生命周期涉及多个阶段，从初始定义、节点输出、到最终的节点消费和值的使用。理解这一流程对于开发和调试 Flowgram 应用至关重要。

### 1. 变量的初始定义 (Initialization)

变量的生命周期始于其在 Flowgram 画布结构中的初始定义。这通常在项目的初始数据文件（例如 `initial-data.ts`）中完成。

*   **位置:** `src/initial-data.ts` 或类似的初始数据文件。
*   **方式:** 在节点的 `data` 属性中，通过定义 `outputs` 字段来声明该节点将要输出的变量。每个输出变量都有一个名称 (`key`)、数据类型 (`type`) 和可选的默认值 (`default`)。例如，在 `start` 节点的配置中添加一个名为 `test` 的字符串变量并赋予初始值 "hello hello"。
*   **作用:** 这一阶段定义了变量的结构和默认状态，但此时变量尚未被变量引擎正式管理或激活。

### 2. 变量的声明与输出 (Declaration and Output)

节点需要将其定义的输出变量正式告知 Flowgram 的变量引擎，以便其他节点可以引用和消费它们。这依赖于 ECS 系统中的 `FlowNodeVariableData` 组件和相应的插件。

*   **核心组件:** `FlowNodeVariableData`。这是一个附加在每个 `FlowNodeEntity`（节点实体）上的组件，专门用于管理该节点的输出变量信息。
*   **关键机制:** 插件（例如 `sync-variable-plugin.ts` 中所示的 `createSyncVariablePlugin`）监听节点生命周期事件（如节点创建 `onNodeCreate`）和节点表单的数据变化。
*   **流程:**
    *   当相关事件发生时，插件获取节点的 `FlowNodeVariableData` 组件。
    *   插件读取节点当前的输出数据（通常来自节点表单的配置）。
    *   这些数据被转换为变量引擎可识别的 AST (Abstract Syntax Tree) 格式，定义了变量的名称、类型和元信息（如标题、图标）。
    *   通过调用 `variableData.setVar()` 方法，节点正式地将这个 AST 格式的变量声明注册到变量引擎中。
*   **作用:** 这一阶段使得变量对整个 Flowgram 环境变得可见，其他节点可以通过其唯一的键 (`key`) 来引用它。

### 3. 变量的消费 (Consumption)

其他节点需要使用某个节点输出的变量时，它们会“消费”这些变量。Flowgram 的变量引擎在运行时负责解析变量引用并提供实际的值。

*   **方式:** 在需要使用变量的节点的配置中，通常通过特定的占位符语法来引用变量，例如在 LLM 节点的 `prompt` 字段中使用 `{节点ID.outputs.变量名}`（如 `{start_0.outputs.test}`）。
*   **运行时:** 当 Flowgram 执行到消费变量的节点时，变量引擎介入。它根据占位符中的键 (`key`) 在全局变量范围内查找对应的变量。
*   **解析与插值:** 变量引擎获取到变量的当前值，并将占位符替换为实际的值。例如，将 `{start_0.outputs.test}` 替换为 "hello hello"。
*   **作用:** 这一阶段实现了不同节点之间的数据流动和交互，使得一个节点的输出可以作为另一个节点的输入。

### 4. 值的获取与显示 (Value Access and Display)

在开发和调试过程中，了解变量在特定时间点（尤其是在被消费时）的实际值非常重要。有几种方式可以实现这一点：

*   **Console 打印:** 在节点的执行逻辑代码中（例如 LLM 节点处理 prompt 的地方），可以使用 `console.log()` 打印出变量解析后的最终值（如插值后的 prompt 字符串）。这有助于在开发者工具的 Console 中查看变量的实际内容。
*   **节点 UI 显示:** 可以修改节点的 React/TypeScript 组件，使其能够获取到运行时解析后的变量值，并将其显示在节点的可视化界面上。这可能需要访问节点的运行时数据或使用特定的 hooks/API 来获取变量的最终值，并将其渲染为文本、图表或其他形式。
*   **变量面板:** Flowgram 环境可能提供一个专门的变量面板或调试工具，允许用户在流程执行过程中检查各个节点输出变量的当前值。

**总结:**

Flowgram ECS 架构下的变量生命周期是一个多阶段的过程：从在初始数据中**定义**其结构和默认值，到通过 `FlowNodeVariableData` 组件和插件向变量引擎**声明和输出**，再到其他节点在运行时通过占位符语法**消费**，最终由变量引擎完成值的**解析和插值**。开发者可以通过 Console 或 UI 显示等方式获取变量的实际值进行调试。理解这一生命周期有助于更有效地构建和管理 Flowgram 工作流。